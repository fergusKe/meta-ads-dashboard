# 📋 廣告顯示組件使用說明

> **目的**：統一所有頁面的廣告顯示格式，讓使用者清楚看到廣告階層和關鍵指標
> **建立日期**：2025-10-03

---

## 🎯 為什麼需要統一組件？

### 問題
之前每個頁面顯示廣告的方式不一致：
- ❌ 只顯示「行銷活動名稱」，無法區分不同廣告
- ❌ 看不出哪個廣告成效好
- ❌ 無法快速找到要優化的目標

### 解決方案
建立統一的廣告顯示組件（`utils/ad_display.py`），提供：
- ✅ **完整廣告階層**：行銷活動 > 廣告組合 > 廣告
- ✅ **關鍵指標一目了然**：花費、ROAS、CPA、CTR
- ✅ **自動排序**：按花費、ROAS 等指標排序
- ✅ **統一格式**：所有頁面使用相同的顯示方式

---

## 📦 提供的功能

### 1. 格式化廣告名稱

```python
from utils.ad_display import format_ad_display_name

# 單一廣告的階層顯示
display_name = format_ad_display_name(row)
# 輸出：20250919｜興趣轉換｜ > 1003｜興趣轉換｜珍奶果汁 > 1003｜珍奶果汁｜366714...
```

### 2. 格式化選項標籤（用於下拉選單）

```python
from utils.ad_display import format_ad_option_label

# 含指標的完整標籤
label = format_ad_option_label(row, include_metrics=True, include_problem=True)
# 輸出：💰$5,230 | ROAS 1.85 | 低ROAS | 20250919｜興趣轉換｜ > 1003｜興趣轉換｜珍奶果汁...
```

### 3. 取得排序後的廣告選項

```python
from utils.ad_display import get_sorted_ad_options

# 取得按花費排序的廣告列表
option_labels, data_map = get_sorted_ad_options(
    df,
    sort_by='spend',  # 'spend', 'roas', 'cpa', 'ctr'
    top_n=10,         # 只取前 10 個
    filters={'問題類型': '低ROAS'}  # 可選篩選
)

# 用於下拉選單
selected = st.selectbox("選擇廣告", options=option_labels)
selected_data = data_map[selected]
```

### 4. 顯示廣告效能表格

```python
from utils.ad_display import display_ad_performance_table

# 自動顯示含廣告階層的表格
display_ad_performance_table(
    df,
    title="廣告效能列表",
    sort_by='spend'  # 按花費排序
)
```

### 5. 顯示 Top/Bottom 廣告對比

```python
from utils.ad_display import display_top_bottom_ads

# 並排顯示最好和最差的廣告
display_top_bottom_ads(
    df,
    metric='購買 ROAS（廣告投資報酬率）',
    top_n=5
)
```

### 6. 取得廣告詳細資訊（用於 AI 分析）

```python
from utils.ad_display import get_ad_details_for_analysis

# 取得結構化的廣告資訊
ad_details = get_ad_details_for_analysis(row)
# 包含：廣告階層、表現數據、受眾資訊、廣告素材、品質評分
```

---

## 💡 使用範例

### 範例 1：素材成效分析頁面

**目標**：顯示表現最好的廣告，讓使用者可以學習成功模式

```python
import streamlit as st
from utils.data_loader import load_meta_ads_data
from utils.ad_display import display_top_bottom_ads, get_sorted_ad_options

st.title("🎨 素材成效分析")

# 載入數據
df = load_meta_ads_data()

# 顯示 Top 10 vs Bottom 10
st.markdown("## 📊 廣告效能對比")
display_top_bottom_ads(df, metric='購買 ROAS（廣告投資報酬率）', top_n=10)

# 讓使用者選擇要深入分析的廣告
st.markdown("## 🔍 選擇廣告深入分析")
option_labels, data_map = get_sorted_ad_options(df, sort_by='roas', top_n=20)

selected = st.selectbox("選擇廣告", options=option_labels)
if selected:
    selected_data = data_map[selected]

    # 顯示該廣告的詳細資訊
    st.write("### 廣告詳情")
    st.write(f"**標題**：{selected_data.get('標題', '未知')}")
    st.write(f"**內文**：{selected_data.get('內文', '未知')}")
    st.write(f"**受眾**：{selected_data.get('目標', '未知')}")
```

---

### 範例 2：活動分析頁面

**目標**：比較不同活動下的廣告表現

```python
import streamlit as st
from utils.data_loader import load_meta_ads_data
from utils.ad_display import display_ad_performance_table, create_ad_dataframe_with_hierarchy

st.title("🎯 活動分析")

df = load_meta_ads_data()

# 選擇活動
campaigns = df['行銷活動名稱'].unique()
selected_campaign = st.selectbox("選擇活動", campaigns)

# 篩選該活動的廣告
campaign_df = df[df['行銷活動名稱'] == selected_campaign]

# 顯示該活動下所有廣告的表現
display_ad_performance_table(
    campaign_df,
    title=f"「{selected_campaign}」廣告效能",
    sort_by='roas'
)

# 高亮顯示最佳和最差廣告
st.markdown("### 📈 該活動表現分析")
display_top_bottom_ads(campaign_df, metric='購買 ROAS（廣告投資報酬率）', top_n=3)
```

---

### 範例 3：即時優化建議頁面（已實作）

```python
from utils.ad_display import get_sorted_ad_options, get_ad_details_for_analysis

# 取得問題廣告列表（按花費排序）
option_labels, data_map = get_sorted_ad_options(
    problem_campaigns,
    sort_by='spend',
    top_n=None  # 顯示所有
)

# 下拉選單
selected = st.selectbox("選擇要分析的廣告", options=option_labels)

if st.button("開始 AI 分析"):
    selected_data = data_map[selected]

    # 取得廣告詳細資訊（用於 AI 分析）
    ad_details = get_ad_details_for_analysis(selected_data)

    # 調用 AI 分析
    ai_analysis = generate_ai_analysis(ad_details)
```

---

### 範例 4：轉換漏斗優化頁面

**目標**：找出漏斗表現差的廣告，進行優化

```python
from utils.ad_display import get_sorted_ad_options

# 計算轉換率
df['轉換率'] = df['購買次數'] / df['觸及人數'] * 100

# 找出轉換率最低的廣告
option_labels, data_map = get_sorted_ad_options(
    df,
    sort_by='ctr',  # 可以自訂排序邏輯
    top_n=10
)

st.selectbox("轉換率最低的廣告（需優化）", options=option_labels)
```

---

## 🔧 需要改進的頁面清單

### 優先級 🔴 高（立即改進）

1. **素材成效分析** (`pages/5_🎨_素材成效分析.py`)
   - 顯示高效文案列表
   - 顯示高效 CTA 按鈕
   - 使用者可以選擇廣告查看素材細節

2. **廣告品質評分** (`pages/6_📈_廣告品質評分.py`)
   - 顯示低品質廣告列表
   - 顯示高品質廣告列表
   - 清楚標示每個廣告的品質評分

3. **轉換漏斗優化** (`pages/7_🔄_轉換漏斗優化.py`)
   - 顯示漏斗表現差的廣告
   - 按照流失率排序

### 優先級 🟡 中（重要但不緊急）

4. **整體效能儀表板** (`pages/1_📊_整體效能儀表板.py`)
   - 顯示 Top 10 廣告
   - 顯示需要關注的廣告

5. **活動分析** (`pages/2_🎯_活動分析.py`)
   - 每個活動下的廣告列表
   - 可以選擇廣告查看詳情

6. **受眾洞察** (`pages/3_👥_受眾洞察.py`)
   - 每個受眾群組的廣告表現
   - 對比不同受眾的廣告效果

7. **ROI 分析** (`pages/4_💰_ROI分析.py`)
   - 按 ROI 排序廣告
   - 找出高投資報酬率的廣告

### 優先級 🟢 低（可選）

8. **詳細數據表格** (`pages/8_📋_詳細數據表格.py`)
   - 已有自訂欄位功能
   - 可加入「廣告階層」欄位選項

---

## 📋 實作步驟（以素材成效分析為例）

### 步驟 1：導入組件

```python
from utils.ad_display import (
    display_top_bottom_ads,
    get_sorted_ad_options,
    get_ad_details_for_analysis,
    display_ad_performance_table
)
```

### 步驟 2：找出需要改進的地方

檢查頁面中：
- 有哪些地方顯示廣告列表？
- 有哪些地方讓使用者選擇廣告？
- 有哪些地方需要對比廣告表現？

### 步驟 3：替換原有顯示方式

**原來的寫法**：
```python
st.dataframe(df[['行銷活動名稱', 'ROAS', '花費']])
```

**改進後**：
```python
display_ad_performance_table(df, sort_by='roas')
```

### 步驟 4：更新選擇廣告的方式

**原來的寫法**：
```python
campaigns = df['行銷活動名稱'].tolist()
selected = st.selectbox("選擇活動", campaigns)
```

**改進後**：
```python
option_labels, data_map = get_sorted_ad_options(df, sort_by='spend')
selected = st.selectbox("選擇廣告", option_labels)
selected_data = data_map[selected]
```

---

## 🎨 顯示格式範例

### 下拉選單格式
```
💰$15,230 | ROAS 1.45 | 低ROAS | 耘初茶食促銷 > 25-45歲女性 > 有機烏龍茶廣告A
💰$8,450 | ROAS 2.35 | 高CPA | 耘初茶食促銷 > 35-55歲男性 > 珍奶果汁廣告B
💰$5,120 | ROAS 3.85 | - | 耘初茶食促銷 > 18-24歲女性 > 養生茶飲廣告C
```

### 表格顯示格式

| 廣告 | ROAS | 花費 | CPA | CTR | 購買數 |
|------|------|------|-----|-----|-------|
| 耘初茶食促銷 > 25-45歲女性 > 有機烏龍茶廣告A | 1.45 | $15,230 | $450 | 2.1% | 34 |
| 耘初茶食促銷 > 35-55歲男性 > 珍奶果汁廣告B | 2.35 | $8,450 | $320 | 2.8% | 26 |
| 耘初茶食促銷 > 18-24歲女性 > 養生茶飲廣告C | 3.85 | $5,120 | $220 | 3.5% | 23 |

---

## ✅ 檢查清單

改進頁面時，確認以下項目：

- [ ] 導入 `utils/ad_display` 組件
- [ ] 所有廣告列表都顯示「廣告階層」（行銷活動 > 廣告組合 > 廣告）
- [ ] 廣告列表都按照有意義的指標排序（花費、ROAS、CPA）
- [ ] 使用者選擇廣告時，可以看到關鍵指標
- [ ] 高效廣告和低效廣告有明確區分（Top/Bottom）
- [ ] 使用者可以快速找到要優化的目標廣告

---

## 🚀 下一步

1. **立即改進**：素材成效分析、廣告品質評分、轉換漏斗優化
2. **測試**：確認顯示格式清晰易讀
3. **收集反饋**：詢問使用者是否更容易找到要優化的廣告
4. **持續優化**：根據反饋調整顯示格式

---

**版本**：v1.0
**建立日期**：2025-10-03
**維護者**：開發團隊
